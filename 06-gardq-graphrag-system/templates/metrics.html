<!-- templates/metrics.html -->
{% extends 'base.html' %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="bg-black border border-orange-brand shadow sm:rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-bold font-helvetica text-white mb-6">
                Statistiques du Knowledge Graph
            </h3>
            
            <!-- Métriques principales -->
            <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
                <div class="bg-black border border-orange-brand rounded-lg p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-orange-brand rounded-md p-3">
                            <svg class="h-6 w-6 text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <div class="ml-5">
                            <dl>
                                <dt class="text-sm font-medium text-orange-grey truncate">
                                    Total Tickets
                                </dt>
                                <dd id="totalTickets" class="mt-1 text-3xl font-semibold text-white">
                                    --
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <div class="bg-black border border-orange-brand rounded-lg p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-orange-brand rounded-md p-3">
                            <svg class="h-6 w-6 text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" />
                            </svg>
                        </div>
                        <div class="ml-5">
                            <dl>
                                <dt class="text-sm font-medium text-orange-grey truncate">
                                    Total Sections
                                </dt>
                                <dd id="totalSections" class="mt-1 text-3xl font-semibold text-white">
                                    --
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <div class="bg-black border border-orange-brand rounded-lg p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-orange-brand rounded-md p-3">
                            <svg class="h-6 w-6 text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                            </svg>
                        </div>
                        <div class="ml-5">
                            <dl>
                                <dt class="text-sm font-medium text-orange-grey truncate">
                                    Relations Intra-ticket
                                </dt>
                                <dd id="intraRelations" class="mt-1 text-3xl font-semibold text-white">
                                    --
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <div class="bg-black border border-orange-brand rounded-lg p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 bg-orange-brand rounded-md p-3">
                            <svg class="h-6 w-6 text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                        </div>
                        <div class="ml-5">
                            <dl>
                                <dt class="text-sm font-medium text-orange-grey truncate">
                                    Relations Inter-ticket
                                </dt>
                                <dd id="interRelations" class="mt-1 text-3xl font-semibold text-white">
                                    --
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Graphiques et détails -->
            <div class="mt-10 grid grid-cols-1 gap-5 sm:grid-cols-2">
                <!-- Distribution des sections -->
                <div class="bg-black border border-orange-brand rounded-lg p-5">
                    <h4 class="text-md font-medium text-white mb-4">Distribution des types de sections</h4>
                    <div id="sectionTypeChart" class="h-64">
                        <!-- Le graphique sera injecté ici -->
                    </div>
                </div>
                
                <!-- Tableau des types de sections -->
                <div class="bg-black border border-orange-brand rounded-lg p-5">
                    <h4 class="text-md font-medium text-white mb-4">Détails des types de sections</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-orange-brand">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-orange-grey uppercase tracking-wider">Type de section</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-orange-grey uppercase tracking-wider">Nombre</th>
                                </tr>
                            </thead>
                            <tbody id="sectionTypesTable" class="divide-y divide-gray-700">
                                <!-- Les données seront injectées ici -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Indicateurs de performance -->
            <div class="mt-10">
                <h4 class="text-md font-medium text-white mb-4">Indicateurs de performance</h4>
                <div class="grid grid-cols-1 gap-5 sm:grid-cols-3">
                    <div class="bg-black border border-orange-brand rounded-lg p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <h5 class="text-sm font-medium text-orange-grey">Relations explicites</h5>
                                <div id="explicitRelations" class="mt-1 text-xl font-semibold text-white">--</div>
                            </div>
                            <div class="flex-shrink-0 bg-orange-brand bg-opacity-20 rounded-full p-3">
                                <svg class="h-5 w-5 text-orange-brand" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-black border border-orange-brand rounded-lg p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <h5 class="text-sm font-medium text-orange-grey">Relations implicites</h5>
                                <div id="implicitRelations" class="mt-1 text-xl font-semibold text-white">--</div>
                            </div>
                            <div class="flex-shrink-0 bg-orange-brand bg-opacity-20 rounded-full p-3">
                                <svg class="h-5 w-5 text-orange-brand" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-black border border-orange-brand rounded-lg p-5">
                        <div class="flex items-center justify-between">
                            <div>
                                <h5 class="text-sm font-medium text-orange-grey">Densité du graphe</h5>
                                <div id="graphDensity" class="mt-1 text-xl font-semibold text-white">--</div>
                            </div>
                            <div class="flex-shrink-0 bg-orange-brand bg-opacity-20 rounded-full p-3">
                                <svg class="h-5 w-5 text-orange-brand" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('/api/metrics/');
        const data = await response.json();
        
        if (data.status === 'success') {
            updateMetrics(data.metrics);
        } else {
            console.error('Erreur lors de la récupération des métriques:', data.message);
        }
    } catch (error) {
        console.error('Erreur:', error);
    }
});

function updateMetrics(metrics) {
    // Mise à jour des compteurs
    document.getElementById('totalTickets').textContent = metrics.total_tickets;
    document.getElementById('totalSections').textContent = metrics.total_sections;
    document.getElementById('intraRelations').textContent = metrics.intra_ticket_relations;
    
    const totalInterRelations = metrics.explicit_relations + metrics.implicit_relations;
    document.getElementById('interRelations').textContent = totalInterRelations;
    
    document.getElementById('explicitRelations').textContent = metrics.explicit_relations;
    document.getElementById('implicitRelations').textContent = metrics.implicit_relations;
    
    // Calcul de la densité du graphe
    // Formule simplifiée: nombre d'arêtes / (nombre de nœuds * (nombre de nœuds - 1) / 2)
    const nodes = metrics.total_tickets + metrics.total_sections;
    const edges = metrics.intra_ticket_relations + totalInterRelations;
    const maxPossibleEdges = nodes * (nodes - 1) / 2;
    const density = (edges / maxPossibleEdges).toFixed(4);
    document.getElementById('graphDensity').textContent = density;
    
    // Mise à jour du tableau des types de sections
    const sectionTypesTable = document.getElementById('sectionTypesTable');
    sectionTypesTable.innerHTML = '';
    
    Object.entries(metrics.section_types).forEach(([type, count]) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-white">${type}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-white">${count}</td>
        `;
        sectionTypesTable.appendChild(row);
    });
    
    // Création du graphique de distribution des types de sections
    const typesOfSections = Object.keys(metrics.section_types);
    const countsOfSections = Object.values(metrics.section_types);
    
    const ctx = document.createElement('canvas');
    document.getElementById('sectionTypeChart').appendChild(ctx);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: typesOfSections,
            datasets: [{
                label: 'Nombre de sections',
                data: countsOfSections,
                backgroundColor: 'rgba(241, 110, 0, 0.6)',
                borderColor: '#FF7900',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#FFFFFF'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#FFFFFF'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#FFFFFF'
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}